<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<script>
var support = {audioContext: true, src_start: true};
if(window.AudioContext)
  audioctx = new window.AudioContext();
else{
  support.audioContext = false;
  audioctx = new (window.webkitAudioContext)();
}
var gainNode = audioctx.createGain();
gainNode.gain.value = 0.5;
gainNode.connect(audioctx.destination);
var currentTime = 0.0;
var bpm = 100;
var runningNotes = new Set();

function genFakePiano(){
  var buff = audioctx.createBuffer(1, 44100 * 2, 44100);
  var dat = buff.getChannelData(0);
  var k = 440 / 44100 * Math.PI * 2;
  for(var t = 0; t < 44100 * 2; t++){
    var sum = 0;
    for(var n = 1; n < 20; n++){
      sum += Math.sin(k * n * t) * Math.exp(-(n - 1) * 0.25);
    }
    dat[t] = sum * Math.exp(-t / (44100 * 0.5)) * 0.5;
  }
  return buff;
}

var fakePno = genFakePiano();

function note(pitch,start,duration){
/*
  var osc = audioctx.createOscillator();
  osc.type = 'sine';
  osc.frequency.value = Math.pow(2, (pitch - 69) / 12) * 440;
  osc.connect(gainNode);
  osc.start(currentTime + start * (60 / bpm));
  osc.stop(currentTime + (start + duration) * (60 / bpm));
  runningNotes.add(osc);
  osc.onended = function(){ runningNotes.delete(osc); };
*/
  var src = audioctx.createBufferSource();
  var env = audioctx.createGain();
  src.buffer = fakePno;
  src.playbackRate.value = Math.pow(2, (pitch - 69) / 12);
  src.connect(env);
  env.connect(gainNode);
  var startTime = currentTime + start * (60 / bpm);
  if(src.start)
    src.start(startTime);
  else {
    support.src_start = 'false';
    src.noteOn(startTime);
  }

  var endtime = currentTime + (start + duration) * (60 / bpm);
  env.gain.setValueAtTime(1, endtime - 0.05);
  env.gain.linearRampToValueAtTime(0, endtime);
  if(src.stop)
    src.stop(endtime);
  else {
    src.noteOff(endTime);
  }
  runningNotes.add(src);
  src.onended = function(){ runningNotes.delete(src); env.disconnect(); };
}

function play(){
  var C=60,D=62,E=64,F=65,G=67,A=69;
  currentTime = audioctx.currentTime;
  note(G, 0, 0.5);
  note(E, 0.5, 0.5);
  note(E, 1, 1);

  note(F, 2, 0.5);
  note(D, 2.5, 0.5);
  note(D, 3, 1);
  
  note(C, 4, 0.5);
  note(D, 4.5, 0.5);
  note(E, 5, 0.5);
  note(F, 5.5, 0.5);
  note(G, 6, 0.5);
  note(G, 6.5, 0.5);
  note(G, 7, 1);

  note(G, 8, 0.5);
  note(E, 8.5, 0.5);
  note(E, 9, 1);

  note(F, 10, 0.5);
  note(D, 10.5, 0.5);
  note(D, 11, 1);

  note(C, 12, 0.5);
  note(E, 12.5, 0.5);
  note(G, 13, 0.5);
  note(G, 13.5, 0.5);
  note(E, 14, 2);

  note(D, 16, 0.5);
  note(D, 16.5, 0.5);
  note(D, 17, 0.5);
  note(D, 17.5, 0.5);
  note(D, 18, 0.5);
  note(E, 18.5, 0.5);
  note(F, 19, 1);

  note(E, 20, 0.5);
  note(E, 20.5, 0.5);
  note(E, 21, 0.5);
  note(E, 21.5, 0.5);
  note(E, 22, 0.5);
  note(F, 22.5, 0.5);
  note(G, 23, 1);

  note(G, 24, 0.5);
  note(E, 24.5, 0.5);
  note(E, 25, 1);

  note(F, 26, 0.5);
  note(D, 26.5, 0.5);
  note(D, 27, 1);

  note(C, 28, 0.5);
  note(E, 28.5, 0.5);
  note(G, 29, 0.5);
  note(G, 29.5, 0.5);
  note(C, 30, 2);
  document.getElementById('warn').innerText = JSON.stringify(support);
}

function stop(){
  for(var node of runningNotes){
    node.stop();
  }
  runningNotes.clear();
}

// for iOS only
var audioUnlocked = false;
window.addEventListener('touchend', function(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  var buf = audioctx.createBuffer(1, 1, 22050);
  var src = audioctx.createBufferSource();

  src.buffer = buf;  

  src.connect(audioctx.destination);
  src.start(0);
  document.getElementById('warn').innerHTML = '';
}, false);
</script>
</head>
<body>
<input type='button' value='Play' onclick='play()'>
<input type='button' value='Stop' onclick='stop()'>
<p id='warn'>Click anywhere on this page to unlock the AudioContext</p>
</body>
</html>