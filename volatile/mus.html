<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<link rel="stylesheet" type="text/css" href="../css/alertbox.css">
<script>
var support = {audioContext: true, src_start: true};
if(window.AudioContext)
  audioctx = new window.AudioContext();
else{
  support.audioContext = false;
  audioctx = new (window.webkitAudioContext)();
}
var gainNode = audioctx.createGain();
gainNode.gain.value = 0.5;
gainNode.connect(audioctx.destination);
var currentTime = 0.0;
var bpm = 100;
var runningNotes = new Set();

function genFakePiano(){
  var buff = audioctx.createBuffer(1, 44100 * 2, 44100);
  var dat = buff.getChannelData(0);
  var k = 440 / 44100 * Math.PI * 2;
  for(var t = 0; t < 44100 * 2; t++){
    var sum = 0;
    for(var n = 1; n < 20; n++){
      sum += Math.sin(k * n * t) * Math.exp(-(n - 1) * 0.25);
    }
    dat[t] = sum * Math.exp(-t / (44100 * 0.5)) * 0.25;
  }
  return buff;
}

var soundBank =
  {fakePno:
    {sample: genFakePiano(), center: 69}
  };
var fakePno = soundBank.fakePno;
function note(pitch,start,duration){
/*
  var osc = audioctx.createOscillator();
  osc.type = 'sine';
  osc.frequency.value = Math.pow(2, (pitch - 69) / 12) * 440;
  osc.connect(gainNode);
  osc.start(currentTime + start * (60 / bpm));
  osc.stop(currentTime + (start + duration) * (60 / bpm));
  runningNotes.add(osc);
  osc.onended = function(){ runningNotes.delete(osc); };
*/
  var src = audioctx.createBufferSource();
  var env = audioctx.createGain();
  src.buffer = fakePno.sample;
  src.playbackRate.value = Math.pow(2, (pitch - fakePno.center) / 12);
  src.loop = true;
  src.loopStart = 0;
  src.loopEnd = 123;
  src.connect(env);
  env.connect(gainNode);
  var startTime = currentTime + start * (60 / bpm);
  if(src.start)
    src.start(startTime);
  else {
    support.src_start = 'false';
    src.noteOn(startTime);
  }

  var endtime = currentTime + (start + duration) * (60 / bpm);
  env.gain.setValueAtTime(1, endtime - 0.05);
  env.gain.linearRampToValueAtTime(0, endtime);
  if(src.stop)
    src.stop(endtime);
  else {
    src.noteOff(endTime);
  }
  runningNotes.add(src);
  src.onended = function(){ runningNotes.delete(src); };
}

function play(){
  var C=60,D=62,E=64,F=65,G=67,A=69,B=71;
  var q=0.25,h=0.5;
  currentTime = audioctx.currentTime;
  /*note(G, 0, 0.5);
  note(E, 0.5, 0.5);
  note(E, 1, 1);

  note(F, 2, 0.5);
  note(D, 2.5, 0.5);
  note(D, 3, 1);

  note(C, 4, 0.5);
  note(D, 4.5, 0.5);
  note(E, 5, 0.5);
  note(F, 5.5, 0.5);
  note(G, 6, 0.5);
  note(G, 6.5, 0.5);
  note(G, 7, 1);

  note(G, 8, 0.5);
  note(E, 8.5, 0.5);
  note(E, 9, 1);

  note(F, 10, 0.5);
  note(D, 10.5, 0.5);
  note(D, 11, 1);

  note(C, 12, 0.5);
  note(E, 12.5, 0.5);
  note(G, 13, 0.5);
  note(G, 13.5, 0.5);
  note(E, 14, 2);

  note(D, 16, 0.5);
  note(D, 16.5, 0.5);
  note(D, 17, 0.5);
  note(D, 17.5, 0.5);
  note(D, 18, 0.5);
  note(E, 18.5, 0.5);
  note(F, 19, 1);

  note(E, 20, 0.5);
  note(E, 20.5, 0.5);
  note(E, 21, 0.5);
  note(E, 21.5, 0.5);
  note(E, 22, 0.5);
  note(F, 22.5, 0.5);
  note(G, 23, 1);

  note(G, 24, 0.5);
  note(E, 24.5, 0.5);
  note(E, 25, 1);

  note(F, 26, 0.5);
  note(D, 26.5, 0.5);
  note(D, 27, 1);

  note(C, 28, 0.5);
  note(E, 28.5, 0.5);
  note(G, 29, 0.5);
  note(G, 29.5, 0.5);
  note(C, 30, 2);*/

  // twinkle twinkle little star
  bpm = 100;
  var pitch = [
    C,h,C,h,G,h,G,h,A,h,A,h,G,1,
    F,h,F,h,E,h,E,h,D,h,D,h,C,1,
    G,h,G,h,F,h,F,h,E,h,E,h,D,1,
    G,h,G,h,F,h,F,h,E,h,E,h,D,1,
    C,h,C,h,G,h,G,h,A,h,A,h,G,1,
    F,h,F,h,E,h,E,h,D,h,D,h,C,1,
  ];

  // Yee
  bpm = 120;
  var pitch = [
    C,1/3,D,2/3,C,1/3,
    E,1,E,1,D,2/3,C,1,D,4/3,G,2/3,G,1,D,1/3,E,2/3,D,1/3,
    F,1,F,1,G,2/3,A,2/3,0,1/3,
    B,1
  ];

  // little bee
  /*bpm = 100;
  var pitch = [
    G,h,E,h,E,1,F,h,D,h,D,1,
    C,h,D,h,E,h,F,h,G,h,G,h,G,1,
    G,h,E,h,E,1,F,h,D,h,D,1,
    C,h,E,h,G,h,G,h,E,2,
    D,h,D,h,D,h,D,h,D,h,E,h,F,1,
    E,h,E,h,E,h,E,h,E,h,F,h,G,1,
    G,h,E,h,E,1,F,h,D,h,D,1,
    C,h,E,h,G,h,G,h,C,2,
  ];*/
  var ff = 0;
  for(var i=0; i<pitch.length; i+=2){
    note(pitch[i], ff, pitch[i+1]);
    ff += pitch[i+1];
  }
  document.getElementById('warn').innerText = JSON.stringify(support);
}

function stop(){
  for(var node of runningNotes){
    node.stop();
  }
  runningNotes.clear();
}

// for iOS only
var audioUnlocked = false;
window.addEventListener('touchend', unlock, false);
function unlock(){
  if(audioUnlocked) return;
  var src = audioctx.createBufferSource();

  src.buffer = fakePno;

  src.connect(gainNode);
  src.start(0);
  document.getElementById('warn').innerHTML = '';
  window.removeEventListener('touchend', unlock);
}
if(/iP[ao]d|iPhone/.test(navigator.userAgent)){
  document.getElementById('warn').innerHTML = 'Click anywhere on this page to unlock the AudioContext';
}

// scream!
function changeInstr(name){
  var instrument = soundBank[name];
  if(instrument){
    fakePno = instrument;
  }
}

function loadSmp(where, instr, prop){
  var req = new XMLHttpRequest();

  req.open('GET', where, true);
  req.responseType = 'arraybuffer';

  req.onload = function(){
    var dat = req.response;
    audioctx.decodeAudioData(dat, function(buffer){
      prop.sample = buffer;
      soundBank[instr] = prop;
    }, function(){
      throw new Error('Cannot decode audio');
    });
  };
  req.send();
}

function Reader(str){
  this.data = str;
  this.pos = 0;
}

Reader.prototype.next = function(){
  return this.data.charAt(this.pos++);
};

Reader.prototype.atEnd = function(){
  return this.pos >= this.data.length;
};

Reader.prototype.peek = function(){
  return this.data.charAt(this.pos);
};

Reader.prototype.rewind = function(){
  --this.pos;
};

Reader.prototype.nextInt = function(){
  var result = null;
  while (!this.atEnd()){
    var char = this.next();
    if (char >= '0' && char <= '9'){
      result = result*10 + parseInt(char);
    }
    else {
      this.rewind();
      break;
    }
  }
  return result;
};

Reader.prototype.nextFloat = function(){
  var integ = this.nextInt();
  if(integ === null){
    return null;
  }
  if(this.next() !== '.'){
    this.rewind();
    return integ;
  }
  var frac = 0;
  var base = 0.1;
  while (!this.atEnd()){
    var char = this.next();
    if (char >= '0' && char <= '9'){
      frac += parseInt(char) * base;
      base *= 0.1;
    }
    else {
      this.rewind();
      break;
    }
  }
  return integ + frac;
};
</script>
</head>
<body>
<input type='button' value='Play' onclick='play()'>
<input type='button' value='Stop' onclick='stop()'>
<p>
  <button onclick='changeInstr("fakePno")'>fakePno</button>
  <button onclick='changeInstr("scream")'>scream</button>
</p>
<p id='warn'></p>

<!-- alert box -->
  <div id='alert' class='alert-box' style='visibility: hidden;'>
    <div class='title'>
      <span>Error</span>
      <input id='close' class='x' value='X' type='button'>
    </div>
    <pre class='description' id='description'>
錯誤訊息會顯示在這裡
    </pre>
  </div>
  <script src='../js/alertbox.js'></script>
<!-- end of alert box -->
<script>
  loadSmp('sound/scream.wav', 'scream', {center: 72});
</script>
</body>
</html>
